# å›¾åƒé¢„å¤„ç†ï¼ˆPreprocessï¼‰è¯¦è§£

> é¢„å¤„ç†æ˜¯å°†åŸå§‹å›¾åƒè½¬æ¢æˆç¥ç»ç½‘ç»œèƒ½è¯†åˆ«çš„æ ¼å¼ã€‚

---

## ğŸ¯ é¢„å¤„ç†çš„ç›®çš„

**ä¸€å¥è¯ï¼š** æŠŠå„ç§å„æ ·çš„å›¾ç‰‡ï¼ˆå¤§å°ä¸åŒã€æ ¼å¼ä¸åŒï¼‰ç»Ÿä¸€æˆæ¨¡å‹è¦æ±‚çš„å›ºå®šæ ¼å¼ã€‚

---

## ğŸ”„ å®Œæ•´æ¨ç†æµç¨‹

```
åŸå§‹å›¾ç‰‡ (ä»»æ„å°ºå¯¸, BGRæ ¼å¼)
    â†“
ã€é¢„å¤„ç†ã€‘
    â†“
640Ã—640 RGB å›¾åƒ
    â†“
ã€ç¥ç»ç½‘ç»œæ¨ç†ã€‘
    â†“
åŸå§‹è¾“å‡º
    â†“
ã€åå¤„ç†ã€‘
    â†“
æ£€æµ‹ç»“æœ
```

---

## ğŸ“Œ é¢„å¤„ç†çš„ 3 ä¸ªæ ¸å¿ƒæ­¥éª¤

### 1ï¸âƒ£ é¢œè‰²ç©ºé—´è½¬æ¢ï¼šBGR â†’ RGB

```python
img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
```

**ä¸ºä»€ä¹ˆè¦è½¬æ¢ï¼Ÿ**

| åº“/æ¡†æ¶ | é»˜è®¤æ ¼å¼ |
|---------|----------|
| OpenCV | BGRï¼ˆè“ç»¿çº¢ï¼‰ |
| ç¥ç»ç½‘ç»œ | RGBï¼ˆçº¢ç»¿è“ï¼‰ |
| PIL | RGB |

**è§£é‡Šï¼š**
- OpenCV è¯»å–å›¾ç‰‡æ˜¯ BGR æ ¼å¼ï¼ˆå†å²åŸå› ï¼‰
- ä½†è®­ç»ƒæ¨¡å‹æ—¶ç”¨çš„æ˜¯ RGB æ ¼å¼
- **å¦‚æœä¸è½¬æ¢ï¼Œé¢œè‰²ä¼šé”™ä¹±ï¼** çº¢è‰²ä¼šè¢«è¯†åˆ«æˆè“è‰²

---

### 2ï¸âƒ£ å›¾åƒç¼©æ”¾ï¼šResize åˆ°å›ºå®šå°ºå¯¸

YOLOv8 è¦æ±‚è¾“å…¥å¿…é¡»æ˜¯ **640Ã—640**ã€‚

æœ‰ä¸¤ç§æ–¹å¼ï¼š

#### æ–¹å¼Aï¼šç›´æ¥æ‹‰ä¼¸ (ç®€å•ä½†ä¼šå˜å½¢)

```python
img = cv2.resize(img, (640, 640))
```

**é—®é¢˜ï¼š** å¦‚æœåŸå›¾æ˜¯ 1920Ã—1080ï¼Œç›´æ¥æ‹‰ä¼¸ä¼šå˜å½¢ã€‚

#### æ–¹å¼Bï¼šLetterbox å¡«å…… (ä¿æŒå®½é«˜æ¯”ï¼Œæ¨è)

```python
def letterbox(img, new_shape=(640, 640), color=(0, 0, 0)):
    """
    ä¿æŒå®½é«˜æ¯”çš„ç¼©æ”¾ + å¡«å……
    
    åŸç†ï¼š
        1. è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆæŒ‰çŸ­è¾¹ï¼‰
        2. ç­‰æ¯”ä¾‹ç¼©æ”¾
        3. å¡«å……é»‘è¾¹åˆ° 640Ã—640
    """
    h, w = img.shape[:2]
    
    # è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆå–çŸ­è¾¹ï¼‰
    scale = min(new_shape[0] / w, new_shape[1] / h)
    
    # ç­‰æ¯”ä¾‹ç¼©æ”¾
    new_w, new_h = int(w * scale), int(h * scale)
    img_resized = cv2.resize(img, (new_w, new_h))
    
    # åˆ›å»º 640Ã—640 çš„é»‘è‰²ç”»å¸ƒ
    img_padded = np.full((new_shape[1], new_shape[0], 3), color, dtype=np.uint8)
    
    # æŠŠç¼©æ”¾åçš„å›¾ç‰‡æ”¾åˆ°ç”»å¸ƒä¸­å¤®
    pad_x = (new_shape[0] - new_w) // 2
    pad_y = (new_shape[1] - new_h) // 2
    img_padded[pad_y:pad_y+new_h, pad_x:pad_x+new_w] = img_resized
    
    return img_padded, scale, (pad_x, pad_y)
```

**ç¤ºä¾‹ï¼š**
```
åŸå›¾ 1920Ã—1080
    â†“ ç¼©æ”¾åˆ° 640Ã—360ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
    â†“ å¡«å……é»‘è¾¹åˆ° 640Ã—640
ç»“æœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é»‘è¾¹ (140px)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚
â”‚   å›¾ç‰‡ (360px)   â”‚
â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   é»‘è¾¹ (140px)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3ï¸âƒ£ æ•°æ®ç±»å‹å’Œå½’ä¸€åŒ–

**é‡è¦åŒºåˆ«ï¼š**

| æ¨¡å‹ç±»å‹ | è¾“å…¥æ ¼å¼ | å½’ä¸€åŒ– |
|----------|----------|--------|
| **ONNX/PyTorch** | `float32` | **éœ€è¦** `/255.` |
| **RKNN** | `uint8` | **ä¸éœ€è¦**ï¼ˆå†…éƒ¨å¤„ç†ï¼‰ |

#### ONNX æ¨¡å‹é¢„å¤„ç†ï¼ˆPC ç«¯ï¼‰

```python
img = img.transpose((2,0,1))        # HWC â†’ CHW (640,640,3) â†’ (3,640,640)
img = img.reshape(1,*img.shape)     # å¢åŠ  batch ç»´åº¦ â†’ (1,3,640,640)
img = img.astype(np.float32)        # è½¬ä¸º float32
img = img / 255.                    # å½’ä¸€åŒ–åˆ° [0,1]
```

#### RKNN æ¨¡å‹é¢„å¤„ç†ï¼ˆæ¿ç«¯ï¼‰

```python
img = img.astype(np.uint8)  # ä¿æŒ uint8 å³å¯
# âœ… ä¸éœ€è¦å½’ä¸€åŒ–ï¼RKNN å†…éƒ¨è‡ªåŠ¨å¤„ç†
```

---

## ğŸ” å®Œæ•´é¢„å¤„ç†ä»£ç ç¤ºä¾‹

### PC ç«¯ï¼ˆONNX æ¨¡å‹ï¼‰

```python
import cv2
import numpy as np

def preprocess_for_onnx(img_path, target_size=(640, 640)):
    """PC ç«¯é¢„å¤„ç†ï¼ˆONNX/PyTorchï¼‰"""
    # 1. è¯»å–å›¾ç‰‡
    img = cv2.imread(img_path)
    
    # 2. Letterbox ç¼©æ”¾
    img, scale, pad = letterbox(img, target_size)
    
    # 3. BGR â†’ RGB
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    
    # 4. HWC â†’ CHW
    img = img.transpose((2, 0, 1))
    
    # 5. å¢åŠ  batch ç»´åº¦
    img = img.reshape(1, *img.shape).astype(np.float32)
    
    # 6. å½’ä¸€åŒ–
    img = img / 255.
    
    return img
```

### æ¿ç«¯ï¼ˆRKNN æ¨¡å‹ï¼‰

```python
def preprocess_for_rknn(img, target_size=(640, 640)):
    """æ¿ç«¯é¢„å¤„ç†ï¼ˆRKNNï¼‰"""
    # 1. Letterbox ç¼©æ”¾
    img, scale, pad = letterbox(img, target_size)
    
    # 2. BGR â†’ RGB
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    
    # 3. ä¿æŒ uint8
    img = img.astype(np.uint8)
    
    return img  # å°±è¿™ä¹ˆç®€å•ï¼
```

---

## âš ï¸ å¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šå¿˜è®° BGR â†’ RGB

```python
# âŒ é”™è¯¯
img = cv2.imread('test.jpg')
outputs = model.run([img])  # é¢œè‰²é”™ä¹±ï¼

# âœ… æ­£ç¡®
img = cv2.imread('test.jpg')
img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
outputs = model.run([img])
```

### é”™è¯¯ 2ï¼šRKNN æ¨¡å‹ç”¨äº† float32

```python
# âŒ é”™è¯¯ï¼ˆæµªè´¹æ€§èƒ½ï¼‰
img = img.astype(np.float32) / 255.  
outputs = rknn.inference([img])

# âœ… æ­£ç¡®
img = img.astype(np.uint8)  # RKNN å†…éƒ¨å¤„ç†å½’ä¸€åŒ–
outputs = rknn.inference([img])
```

### é”™è¯¯ 3ï¼šç›´æ¥æ‹‰ä¼¸å¯¼è‡´å˜å½¢

```python
# âŒ é”™è¯¯ï¼ˆå›¾ç‰‡å˜å½¢ï¼‰
img = cv2.resize(img, (640, 640))

# âœ… æ­£ç¡®ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
img, scale, pad = letterbox(img, (640, 640))
```

---

## ğŸ“Š é¢„å¤„ç†å‰åå¯¹æ¯”

| æ­¥éª¤ | è¾“å…¥ | è¾“å‡º |
|------|------|------|
| **åŸå§‹å›¾ç‰‡** | test.jpg (1920Ã—1080, BGR) | - |
| **Letterbox** | 1920Ã—1080 | 640Ã—640 (æœ‰é»‘è¾¹) |
| **BGRâ†’RGB** | BGR | RGB |
| **æ•°æ®ç±»å‹** | uint8 (0-255) | RKNN: uint8 / ONNX: float32 (0-1) |

---

## ğŸ”‘ å…³é”®è¦ç‚¹

1. **BGR â†’ RGB å¿…ä¸å¯å°‘** - OpenCV å’Œæ¨¡å‹æ ¼å¼ä¸åŒ
2. **Letterbox ä¼˜äºç›´æ¥ resize** - é¿å…å˜å½¢
3. **RKNN ä¸éœ€è¦å½’ä¸€åŒ–** - å†…éƒ¨è‡ªåŠ¨å¤„ç†ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
4. **PC å’Œæ¿ç«¯é¢„å¤„ç†ä¸åŒ** - ONNX éœ€è¦æ›´å¤šæ­¥éª¤

---

## âœ… æ€»ç»“

é¢„å¤„ç†çš„æœ¬è´¨å°±æ˜¯ **"æŠŠå›¾ç‰‡å˜æˆæ¨¡å‹èƒ½åƒçš„æ ¼å¼"**ï¼š

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| å°ºå¯¸ä¸åŒ | Letterbox ç¼©æ”¾åˆ° 640Ã—640 |
| é¢œè‰²æ ¼å¼ä¸åŒ | BGR â†’ RGB |
| æ•°æ®ç±»å‹ä¸åŒ | ONNX ç”¨ float32ï¼ŒRKNN ç”¨ uint8 |

**è®°ä½ï¼šé¢„å¤„ç†é”™äº†ï¼Œæ¨¡å‹å†å¥½ä¹Ÿç™½æ­ï¼**
