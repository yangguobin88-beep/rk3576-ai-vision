# YOLO åå¤„ç†ä»£ç è¯¦è§£

> æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£ YOLOv8 æ£€æµ‹æ¨¡å‹çš„åå¤„ç†æµç¨‹å’Œä»£ç å®ç°ã€‚

---

## ğŸ”„ æ•´ä½“æµç¨‹

```
æ¨¡å‹è¾“å‡º (8400ä¸ªå€™é€‰æ¡†)
    â†“
1. box_process()    â†’ è§£æåæ ‡
    â†“
2. filter_boxes()   â†’ è¿‡æ»¤ä½ç½®ä¿¡åº¦
    â†“
3. nms_boxes()      â†’ å»é™¤é‡å æ¡†
    â†“
æœ€ç»ˆç»“æœ (å‡ ä¸ªæœ‰æ•ˆæ£€æµ‹æ¡†)
```

---

## ğŸ“Œ æ ¸å¿ƒæ¦‚å¿µ

### YOLOv8 è¾“å‡ºæ ¼å¼
- **è¾“å…¥å›¾åƒ**: 640Ã—640
- **è¾“å‡º**: 3 ä¸ªä¸åŒå°ºåº¦çš„ç‰¹å¾å›¾
  - 80Ã—80 (å°ç›®æ ‡)
  - 40Ã—40 (ä¸­ç›®æ ‡)
  - 20Ã—20 (å¤§ç›®æ ‡)
- **æ¯ä¸ªä½ç½®**: 4åæ ‡ + 80ç±»åˆ«æ¦‚ç‡
- **æ€»å€™é€‰æ¡†**: 80Ã—80 + 40Ã—40 + 20Ã—20 = 8400 ä¸ª

---

## ğŸ§© å‡½æ•°1: filter_boxes() - è¿‡æ»¤ä½ç½®ä¿¡åº¦

```python
def filter_boxes(boxes, box_confidences, box_class_probs):
    """
    åŠŸèƒ½ï¼šè¿‡æ»¤æ‰ç½®ä¿¡åº¦ä½äºé˜ˆå€¼çš„æ£€æµ‹æ¡†
    
    å‚æ•°ï¼š
        boxes: æ‰€æœ‰å€™é€‰æ¡†åæ ‡ [8400, 4]
        box_confidences: æ¯ä¸ªæ¡†æœ‰ç›®æ ‡çš„æ¦‚ç‡ [8400]
        box_class_probs: æ¯ä¸ªæ¡†å±äºå„ç±»åˆ«çš„æ¦‚ç‡ [8400, 80]
    
    è¿”å›ï¼š
        boxes: ä¿ç•™çš„æ¡†
        classes: å¯¹åº”çš„ç±»åˆ«
        scores: å¯¹åº”çš„ç½®ä¿¡åº¦
    """
    # 1. æ‰¾åˆ°æ¯ä¸ªæ¡†å¾—åˆ†æœ€é«˜çš„ç±»åˆ«
    class_max_score = np.max(box_class_probs, axis=-1)  # [8400]
    classes = np.argmax(box_class_probs, axis=-1)       # [8400]
    
    # 2. è®¡ç®—æœ€ç»ˆå¾—åˆ† = ç›®æ ‡æ¦‚ç‡ Ã— ç±»åˆ«æ¦‚ç‡
    # åªä¿ç•™å¾—åˆ† > OBJ_THRESH (0.25) çš„æ¡†
    _class_pos = np.where(class_max_score * box_confidences >= OBJ_THRESH)
    
    # 3. ç­›é€‰å‡ºæœ‰æ•ˆçš„æ¡†
    scores = (class_max_score * box_confidences)[_class_pos]
    boxes = boxes[_class_pos]
    classes = classes[_class_pos]
    
    return boxes, classes, scores
```

**é€šä¿—è§£é‡Šï¼š**
- æ¨¡å‹æ£€æµ‹äº† 8400 ä¸ªä½ç½®ï¼Œå¤§éƒ¨åˆ†æ˜¯èƒŒæ™¯
- åªæœ‰å¾—åˆ† > 0.25 çš„ä½ç½®æ‰å¯èƒ½æ˜¯ç›®æ ‡
- è¿™ä¸€æ­¥ä» 8400 ä¸ªç­›é€‰åˆ°å‡ åä¸ª

---

## ğŸ§© å‡½æ•°2: nms_boxes() - éæå¤§å€¼æŠ‘åˆ¶

**é—®é¢˜ï¼š** ä¸€ä¸ªäººå¯èƒ½è¢« 5 ä¸ªé‡å çš„æ¡†æ£€æµ‹åˆ°ï¼Œéœ€è¦åªä¿ç•™æœ€å¥½çš„ 1 ä¸ªã€‚

```python
def nms_boxes(boxes, scores):
    """
    åŠŸèƒ½ï¼šå»é™¤é‡å çš„æ£€æµ‹æ¡†ï¼Œåªä¿ç•™å¾—åˆ†æœ€é«˜çš„
    
    åŸç†ï¼š
        1. æŒ‰å¾—åˆ†ä»é«˜åˆ°ä½æ’åº
        2. ä¿ç•™å¾—åˆ†æœ€é«˜çš„æ¡†
        3. åˆ é™¤ä¸å®ƒé‡å åº¦(IoU) > 0.45 çš„æ¡†
        4. å¯¹å‰©ä½™æ¡†é‡å¤ 2-3
    """
    # æå–åæ ‡
    x = boxes[:, 0]  # å·¦ä¸Šè§’ x
    y = boxes[:, 1]  # å·¦ä¸Šè§’ y
    w = boxes[:, 2] - boxes[:, 0]  # å®½åº¦
    h = boxes[:, 3] - boxes[:, 1]  # é«˜åº¦
    
    areas = w * h  # è®¡ç®—é¢ç§¯
    order = scores.argsort()[::-1]  # æŒ‰å¾—åˆ†æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰
    
    keep = []  # ä¿ç•™çš„æ¡†ç´¢å¼•
    while order.size > 0:
        i = order[0]  # å½“å‰å¾—åˆ†æœ€é«˜çš„æ¡†
        keep.append(i)
        
        # è®¡ç®—å½“å‰æ¡†ä¸å…¶ä»–æ‰€æœ‰æ¡†çš„ IoU
        xx1 = np.maximum(x[i], x[order[1:]])  # äº¤é›†å·¦ä¸Šè§’ x
        yy1 = np.maximum(y[i], y[order[1:]])  # äº¤é›†å·¦ä¸Šè§’ y
        xx2 = np.minimum(x[i]+w[i], x[order[1:]]+w[order[1:]])  # äº¤é›†å³ä¸‹è§’ x
        yy2 = np.minimum(y[i]+h[i], y[order[1:]]+h[order[1:]])  # äº¤é›†å³ä¸‹è§’ y
        
        inter = np.maximum(0, xx2-xx1) * np.maximum(0, yy2-yy1)  # äº¤é›†é¢ç§¯
        iou = inter / (areas[i] + areas[order[1:]] - inter)  # IoU = äº¤é›†/å¹¶é›†
        
        # åªä¿ç•™ IoU < 0.45 çš„æ¡†ï¼ˆå³é‡å åº¦ä¸é«˜çš„æ¡†ï¼‰
        inds = np.where(iou <= NMS_THRESH)[0]
        order = order[inds + 1]
    
    return np.array(keep)
```

**é€šä¿—è§£é‡Š - ä»€ä¹ˆæ˜¯ IoUï¼š**
```
IoU (äº¤å¹¶æ¯”) = ä¸¤ä¸ªæ¡†é‡å é¢ç§¯ / ä¸¤ä¸ªæ¡†æ€»é¢ç§¯

å¦‚æœ IoU > 0.45ï¼Œè®¤ä¸ºæ˜¯åŒä¸€ç›®æ ‡ï¼Œåˆ é™¤å¾—åˆ†ä½çš„æ¡†
```

---

## ğŸ§© å‡½æ•°3: post_process() - å®Œæ•´åå¤„ç†æµç¨‹

```python
def post_process(input_data):
    """
    å®Œæ•´åå¤„ç†æµç¨‹
    
    å‚æ•°ï¼š
        input_data: æ¨¡å‹çš„åŸå§‹è¾“å‡ºï¼ˆå¤šä¸ª tensorï¼‰
    
    è¿”å›ï¼š
        boxes: æ£€æµ‹æ¡†åæ ‡ [[x1,y1,x2,y2], ...]
        classes: ç±»åˆ« ID [0, 5, ...]
        scores: ç½®ä¿¡åº¦ [0.88, 0.85, ...]
    """
    # 1. å¤„ç† 3 ä¸ªä¸åŒå°ºåº¦çš„è¾“å‡º
    # 2. åˆå¹¶æ‰€æœ‰å°ºåº¦çš„ç»“æœ
    # 3. è¿‡æ»¤ä½ç½®ä¿¡åº¦ (8400 â†’ å‡ åä¸ª)
    # 4. NMS å»é‡ (å‡ åä¸ª â†’ å‡ ä¸ª)
    
    return boxes, classes, scores
```

---

## ğŸ“Š å®é™…ä¾‹å­

**è¾“å…¥ï¼š** bus.jpg (640Ã—640)

**æ¨¡å‹è¾“å‡ºï¼š** 8400 ä¸ªå€™é€‰æ¡†

**filter_boxes åï¼š** çº¦ 50 ä¸ªæ¡†

**NMS åï¼š** 5 ä¸ªæ¡†
```
person @ (211 241 283 507) 0.880
person @ (109 235 224 536) 0.877
person @ (477 223 560 521) 0.873
person @ (80 327 116 513) 0.328
bus    @ (99 135 550 456) 0.847
```

---

## ğŸ”‘ å…³é”®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | å«ä¹‰ |
|------|--------|------|
| `OBJ_THRESH` | 0.25 | ç½®ä¿¡åº¦é˜ˆå€¼ï¼Œä½äºæ­¤å€¼çš„æ¡†è¢«ä¸¢å¼ƒ |
| `NMS_THRESH` | 0.45 | IoUé˜ˆå€¼ï¼Œé«˜äºæ­¤å€¼çš„é‡å æ¡†è¢«åˆå¹¶ |
| `IMG_SIZE` | (640,640) | è¾“å…¥å›¾åƒå°ºå¯¸ |

---

## âœ… æ€»ç»“

åå¤„ç†çš„æœ¬è´¨å°±æ˜¯ **"ä»æµ·é‡å€™é€‰ä¸­ç­›é€‰å‡ºçœŸæ­£çš„ç›®æ ‡"**ï¼š

1. **filter_boxes**: æ‰”æ‰ 99% çš„èƒŒæ™¯
2. **nms_boxes**: åˆå¹¶é‡å¤æ£€æµ‹
3. æœ€ç»ˆå¾—åˆ°å¹²å‡€çš„æ£€æµ‹ç»“æœ

ç†è§£äº†è¿™ä¸ªæµç¨‹ï¼Œä½ å°±èƒ½çœ‹æ‡‚ä»»ä½•ç›®æ ‡æ£€æµ‹æ¨¡å‹çš„åå¤„ç†ä»£ç ï¼
